<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mealty WebApp</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script>
    const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    if (tg) tg.ready();
  </script>
</head>
<body>
  <header class="header">
    <h1>Mealty WebApp</h1>
  </header>

  <main class="container">
    <div class="controls">
      <button id="orderAllBtn" class="order-btn">Заказать (<span id="totalQty">0</span>)</button>
      <div class="category-row">
        <label for="category">Категория:</label>
        <select id="category">
          <option value="all">Все</option>
          <option value="selected">Выбранные</option>
          {% for c in categories %}
            <option value="{{ c.id }}">{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
      <!--   <button id="refreshBtn">Обновить</button>-->
    </div>

    <div id="grid" class="grid">
      {% for p in products %}
      <div class="card" 
     data-category="{{ p.category_id }}" 
     data-id="{{ p.id }}" 
     data-seller-id="{{ p.seller_id }}"
     data-product-id="{{ p.product_id }}"
     data-desc="{{ p.desc|escape }}"
     data-title="{{ p.title|escape }}"
     data-price="{{ p.price }}">
<div class="card-image">
  {% if p.is_new %}
    <img class="badge-new" src="/static/new.png" alt="Новинка">
  {% endif %}

  <div class="img-wrap">
    <img
      class="product-img lazy"
      src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw=="
      data-src="{{ p.img }}"
      {% if p.img_srcset %} data-srcset="{{ p.img_srcset }}" {% endif %}
      loading="lazy"
      alt="{{ p.title | e }}"
    >
  </div>

  {% if p.out_of_stock %}
    <div class="soldout">РАСПРОДАНО</div>
  {% endif %}
</div>

        <div class="card-body" >
          <div class="title">{{ p.title }}</div>
          <div class="subtitle">{{ p.subtitle }}</div>
          <div class="price">{{ p.price }} руб.</div>
          <div class="quantity-controls">
            <button class="qty-btn qty-minus" onclick="changeQuantity('{{ p.id }}', -1)">-</button>
            <input type="number" class="qty-input" id="qty-{{ p.id }}" value="0" min="0" readonly>
            <button class="qty-btn qty-plus" onclick="changeQuantity('{{ p.id }}', 1)">+</button>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </main>

  <!-- modal -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-inner">
      <button class="modal-close" id="modalClose">&times;</button>
      <img id="modalImg" src="" alt="">
      <h2 class="title" id="modalTitle"></h2>
      <p class="subtitle" id="modalSubtitle"></p>
      <p id="modalDesc"></p>
      <p><b class="price" id="modalPrice"></b></p>
      <div class="modal-actions">
        <div class="quantity-controls">
          <button class="qty-btn qty-minus" onclick="changeModalQuantity(-1)">-</button>
          <input type="number" class="qty-input" id="modal-qty" value="0" min="0" readonly>
          <button class="qty-btn qty-plus" onclick="changeModalQuantity(1)">+</button>
        </div>
      </div>
    </div>
  </div>

  <script src="/static/lazyload.js"></script>
  <script>
    // const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;
    // if (tg) tg.ready();

    // фильтр категорий
    function applyFilter() {
      const sel = document.getElementById('category').value;
      document.querySelectorAll('#grid .card').forEach(card => {
        const id = card.dataset.id;
        const qtyInput = document.getElementById('qty-' + id);
        const count = parseInt(qtyInput.value) || 0;
        if (sel === 'all') {
          card.style.display = '';
        } else if (sel === 'selected') {
          card.style.display = count > 0 ? '' : 'none';
        } else if (card.dataset.category === sel) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    }

    document.getElementById('category').addEventListener('change', function() {
      applyFilter();
      window.lazyloadObserve && window.lazyloadObserve();
    });

    // делегирование клика по картинке → модалка
    document.getElementById('grid').addEventListener('click', function(e) {
      const t = e.target;
      if (t && t.matches && t.matches('img.product-img')) {
        openModal(t);
      }
    });

    function openModal(imgEl) {
      const card = imgEl.closest('.card');
      const id = card.dataset.id;
      const title = card.querySelector('.title')?.textContent || '';
      const subtitle = card.querySelector('.subtitle')?.textContent || '';
      const price = card.querySelector('.price')?.textContent || '';
      const desc = card.dataset.desc || '';      

      const src = imgEl.dataset.src || imgEl.src;

      document.getElementById('modalImg').src = src;
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalSubtitle').textContent = subtitle;
      document.getElementById("modalDesc").textContent = desc;
      document.getElementById('modalPrice').textContent = price;   

      // синхронизируем количество из карточки товара
      const cardQty = document.getElementById('qty-' + id);
      const modalQty = document.getElementById('modal-qty');
      if (cardQty && modalQty) {
        modalQty.value = cardQty.value;
      }

      // сохраняем id в модальном окне для синхронизации
      document.getElementById('modal').dataset.productId = id;

      // убираем обработчик заказа из модального окна, так как теперь общая кнопка

      document.getElementById('modal').style.display = 'flex';
      document.getElementById('modal').setAttribute('aria-hidden', 'false');
    }

    document.getElementById('modalClose').addEventListener('click', closeModal);
    document.getElementById('modal').addEventListener('click', (e) => {
      if (e.target === e.currentTarget) closeModal();
    });
    function closeModal() {
      document.getElementById('modal').style.display = 'none';
      document.getElementById('modal').setAttribute('aria-hidden', 'true');
    }

    // функции для управления количеством
    function updateTotalQuantity() {
      let total = 0;
      document.querySelectorAll('#grid .card').forEach(card => {
        const id = card.dataset.id;
        const qtyInput = document.getElementById('qty-' + id);
        const count = parseInt(qtyInput.value) || 0;
        total += count;
      });
      document.getElementById('totalQty').textContent = total;
      // обновляем фильтр, если выбрана "Выбранные"
      const sel = document.getElementById('category').value;
      if (sel === 'selected') {
        applyFilter();
      }
    }

    function changeQuantity(productId, delta) {
      const input = document.getElementById('qty-' + productId);
      let currentValue = parseInt(input.value) || 0;
      currentValue += delta;
      if (currentValue < 0) currentValue = 0;
      input.value = currentValue;
      updateTotalQuantity();
      applyFilter();
    }

    function changeModalQuantity(delta) {
      const input = document.getElementById('modal-qty');
      let currentValue = parseInt(input.value) || 0;
      currentValue += delta;
      if (currentValue < 0) currentValue = 0;
      input.value = currentValue;
      // синхронизируем с карточкой
      const modal = document.getElementById('modal');
      const productId = modal.dataset.productId;
      if (productId) {
        const cardQty = document.getElementById('qty-' + productId);
        if (cardQty) {
          cardQty.value = input.value;
        }
      }
      updateTotalQuantity();
      applyFilter();
    }


    function orderAllProducts() {
      const orders = [];
      document.querySelectorAll('#grid .card').forEach(card => {
        const id = card.dataset.id;
        const qtyInput = document.getElementById('qty-' + id);
        const count = parseInt(qtyInput.value) || 0;
        if (count > 0) {
          orders.push({
            product_id: card.dataset.productId,
            seller_id: card.dataset.sellerId,
            title: card.dataset.title,
            price: card.dataset.price,
            count: count,
            desc: card.dataset.desc,
            link: 'https://www.mealty.ru/#sproduct_' + card.dataset.sellerId
          });
        }
      });

      if (orders.length === 0) {
        alert('Выберите хотя бы один товар');
        return;
      }

      const json = JSON.stringify(orders);
      const MAX_PAYLOAD = 4096; // лимит Telegram WebApp.sendData в байтах
      // считаем размер в байтах UTF-8 (используем TextEncoder)
      const byteLen = new TextEncoder().encode(json).length;
      if (byteLen > MAX_PAYLOAD) {
        alert('Данные слишком большие для отправки (' + byteLen + ' байт)');
        return;
      }

      if (!tg || typeof tg.sendData !== 'function') {
        alert('Telegram WebApp недоступен');
        return;
      }

      // Отладка: выводим initData и platform в консоль
      console.log('tg.initData:', tg.initData, 'tg.platform:', tg.platform);

      try {
        tg.sendData(json);
        //alert('Данные отправлены боту'); // Опционально для отладки
        return;
      } catch (err) {
        alert('Отправка боту не удалась, Ошибка:\n' + (err && err.message ? err.message : err));
        return;
      }
    }

    

    document.getElementById('orderAllBtn').addEventListener('click', orderAllProducts);

    // инициализация
    updateTotalQuantity();
  </script>
</body>
</html>
